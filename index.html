<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Map Dashboard - Marker dengan Nama</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      #map {
        height: 100%;
        width: 100%;
        border-radius: 12px;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-poppins">
    <!-- Navbar -->
    <header
      class="bg-white shadow-md py-4 px-6 flex items-center justify-between"
    >
      <h1 class="text-2xl font-bold text-gray-700 flex items-center gap-2">
        üåç Smart Map Dashboard
      </h1>
      <div class="flex items-center gap-4">
        <button
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
        >
          Refresh
        </button>
        <img
          src="https://ui-avatars.com/api/?name=Ganteng"
          class="w-10 h-10 rounded-full border-2 border-blue-500"
        />
      </div>
    </header>

    <!-- Main Layout -->
    <div class="flex h-[calc(100vh-70px)]">
      <!-- Sidebar -->
      <aside class="w-80 bg-white shadow-md p-6 flex flex-col justify-between">
        <div>
          <h2 class="text-lg font-semibold mb-3">üìç Informasi Lokasi</h2>
          <div
            id="infoBox"
            class="p-3 bg-gray-50 rounded-lg text-gray-600 text-sm"
          >
            Klik atau geser marker untuk melihat posisi terbaru.
          </div>

          <h2 class="text-lg font-semibold mt-6 mb-3">üìä Statistik</h2>
          <ul class="text-gray-600 space-y-2 text-sm">
            <li>üó∫Ô∏è Total Marker: <b id="markerCount">1</b></li>
            <li>üü© Total Area: <b id="areaCount">0</b></li>
            <li>üì¶ Area Aktif: <b>Bandung</b></li>
          </ul>

          <h2 class="text-lg font-semibold mt-6 mb-3">‚öôÔ∏è Aksi Cepat</h2>
          <div class="space-y-2">
            <button
              id="addMarkerBtn"
              class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition"
            >
              ‚ûï Tambah Marker
            </button>
            <button
              id="drawAreaBtn"
              class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
            >
              üü© Buat Daerah
            </button>
            <button
              id="finishAreaBtn"
              class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition hidden"
            >
              ‚úÖ Selesai Gambar
            </button>
          </div>
        </div>

        <footer class="text-center text-gray-400 text-xs pt-4 border-t">
          Dibuat dengan ‚ù§Ô∏è oleh si Ganteng
        </footer>
      </aside>

      <!-- Peta -->
      <main class="flex-1 p-4">
        <div id="map" class="h-full shadow-lg"></div>
      </main>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // API base URL (backend)
      const API_BASE = "https://be-geojson-production.up.railway.app/api";

      // Inisialisasi peta
      var map = L.map("map").setView([-6.9175, 107.6191], 13);

      // Tambahkan tile layer
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      }).addTo(map);

      // === Variabel global ===
      var markerCount = 0;
      var areaCount = 0;
      var isDrawing = false;
      var currentPolygonPoints = [];

      // === Helper: update info ===
      function updateInfo(lat, lng, name = "") {
        document.getElementById("infoBox").innerHTML = `${
          name ? `<b>Nama Marker:</b> ${name}<br>` : ""
        }
         <b>Latitude:</b> ${lat.toFixed(5)} <br>
         <b>Longitude:</b> ${lng.toFixed(5)}`;
      }

      // === API helpers ===
      async function fetchMarkers() {
        try {
          const res = await fetch(`${API_BASE}/markers`);
          if (!res.ok) throw new Error("Failed to fetch markers");
          const markers = await res.json();
          markers.forEach((m) => {
            // assume coordinates are [lng, lat]
            const coords =
              m.location && m.location.coordinates
                ? m.location.coordinates
                : null;
            if (coords && coords.length === 2) {
              addMarker(coords[1], coords[0], m.name, false);
            }
          });
          markerCount = markers.length;
          document.getElementById("markerCount").textContent = markerCount;
        } catch (err) {
          console.warn("fetchMarkers error", err);
        }
      }

      async function fetchAreas() {
        try {
          const res = await fetch(`${API_BASE}/areas`);
          if (!res.ok) throw new Error("Failed to fetch areas");
          const areas = await res.json();
          areas.forEach((a) => {
            if (a.coordinates && a.coordinates.length) {
              // a.coordinates is expected as [ [ [lng,lat], ... ] ]
              const rings = a.coordinates[0];
              const pts = rings.map((p) => [p[1], p[0]]); // convert to [lat,lng]
              L.polygon(pts, { color: "green", fillOpacity: 0.3 }).addTo(map);
            }
          });
          areaCount = areas.length;
          document.getElementById("areaCount").textContent = areaCount;
        } catch (err) {
          console.warn("fetchAreas error", err);
        }
      }

      async function postMarker(name, lat, lng) {
        const payload = {
          name: name,
          location: { type: "Point", coordinates: [lng, lat] },
        };
        try {
          const res = await fetch(`${API_BASE}/markers`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to create marker");
          const created = await res.json();
          return created;
        } catch (err) {
          console.warn("postMarker error", err);
          return null;
        }
      }

      async function postArea(name, latlngs) {
        // latlngs: array of [lat, lng]
        const ring = latlngs.map((p) => [p[1], p[0]]); // to [lng, lat]
        // ensure ring is closed
        if (
          ring.length &&
          (ring[0][0] !== ring[ring.length - 1][0] ||
            ring[0][1] !== ring[ring.length - 1][1])
        ) {
          ring.push([ring[0][0], ring[0][1]]);
        }
        const payload = {
          name: name,
          coordinates: { type: "Polygon", coordinates: [ring] },
        };
        try {
          const res = await fetch(`${API_BASE}/areas`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to create area");
          const created = await res.json();
          return created;
        } catch (err) {
          console.warn("postArea error", err);
          return null;
        }
      }

      // === Fungsi tambah marker (lokal + optional POST) ===
      function addMarker(lat, lng, name = "Marker Baru", doPost = true) {
        var marker = L.marker([lat, lng], { draggable: true })
          .addTo(map)
          .bindPopup(`<b>${name}</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}`)
          .openPopup();

        marker.on("dragend", function (e) {
          var pos = e.target.getLatLng();
          updateInfo(pos.lat, pos.lng, name);
          marker.bindPopup(
            `<b>${name}</b><br>${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`
          );
        });

        marker.on("click", function (e) {
          updateInfo(e.latlng.lat, e.latlng.lng, name);
        });

        if (doPost) {
          postMarker(name, lat, lng).then((created) => {
            if (created) {
              markerCount++;
              document.getElementById("markerCount").textContent = markerCount;
            }
          });
        } else {
          markerCount++;
          document.getElementById("markerCount").textContent = markerCount;
        }
      }

      // === Init: load existing markers & areas from backend ===
      fetchMarkers();
      fetchAreas();

      // === Tombol tambah marker (mengirim ke backend) ===
      document
        .getElementById("addMarkerBtn")
        .addEventListener("click", function () {
          var lat = -6.9175 + (Math.random() - 0.5) * 0.02;
          var lng = 107.6191 + (Math.random() - 0.5) * 0.02;
          var name = prompt("Masukkan nama marker:", "Marker Baru");
          if (name) {
            addMarker(lat, lng, name, true);
          } else {
            addMarker(lat, lng, "Tanpa Nama", true);
          }
        });

      // === Mode menggambar area ===
      document
        .getElementById("drawAreaBtn")
        .addEventListener("click", function () {
          isDrawing = true;
          currentPolygonPoints = [];
          document.getElementById("drawAreaBtn").classList.add("hidden");
          document.getElementById("finishAreaBtn").classList.remove("hidden");
          document.getElementById("infoBox").innerHTML =
            "üü¢ Klik di peta untuk menandai titik area. Klik 'Selesai Gambar' untuk menutup polygon.";
        });

      // === Selesai menggambar area ===
      document
        .getElementById("finishAreaBtn")
        .addEventListener("click", async function () {
          if (currentPolygonPoints.length > 2) {
            L.polygon(currentPolygonPoints, {
              color: "green",
              fillOpacity: 0.3,
            }).addTo(map);
            // Ask for a name and POST to backend
            const name =
              prompt("Masukkan nama area:", "Area Baru") || "Area Baru";
            const created = await postArea(name, currentPolygonPoints);
            if (created) {
              areaCount++;
              document.getElementById("areaCount").textContent = areaCount;
              document.getElementById(
                "infoBox"
              ).innerHTML = `üü© Area selesai dibuat!<br>Jumlah titik: ${currentPolygonPoints.length}`;
            }
          } else {
            alert("Minimal 3 titik untuk membentuk area!");
          }
          isDrawing = false;
          document.getElementById("drawAreaBtn").classList.remove("hidden");
          document.getElementById("finishAreaBtn").classList.add("hidden");
          currentPolygonPoints = [];
        });

      // === Event klik di peta ===
      map.on("click", function (e) {
        if (isDrawing) {
          currentPolygonPoints.push([e.latlng.lat, e.latlng.lng]);
          L.circleMarker(e.latlng, { radius: 5, color: "green" }).addTo(map);
          updateInfo(e.latlng.lat, e.latlng.lng);
        } else {
          updateInfo(e.latlng.lat, e.latlng.lng);
        }
      });
    </script>
  </body>
</html>
