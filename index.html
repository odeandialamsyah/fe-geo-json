<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Map Dashboard - Marker dengan Nama</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      #map {
        height: 100%;
        width: 100%;
        border-radius: 12px;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-poppins">
    <!-- Navbar -->
    <header
      class="bg-white shadow-md py-4 px-6 flex items-center justify-between"
    >
      <h1 class="text-2xl font-bold text-gray-700 flex items-center gap-2">
        üåç Smart Map Dashboard
      </h1>
      <div class="flex items-center gap-4">
        <button
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
        >
          Refresh
        </button>
        <img
          src="https://ui-avatars.com/api/?name=Ganteng"
          class="w-10 h-10 rounded-full border-2 border-blue-500"
        />
      </div>
    </header>

    <!-- Main Layout -->
    <div class="flex h-[calc(100vh-70px)]">
      <!-- Sidebar -->
      <aside class="w-80 bg-white shadow-md p-6 flex flex-col justify-between">
        <div>
          <h2 class="text-lg font-semibold mb-3">üìç Informasi Lokasi</h2>
          <div
            id="infoBox"
            class="p-3 bg-gray-50 rounded-lg text-gray-600 text-sm"
          >
            Klik atau geser marker untuk melihat posisi terbaru.
          </div>

          <h2 class="text-lg font-semibold mt-6 mb-3">üìä Statistik</h2>
          <ul class="text-gray-600 space-y-2 text-sm">
            <li>üó∫Ô∏è Total Marker: <b id="markerCount">1</b></li>
            <li>üü© Total Area: <b id="areaCount">0</b></li>
            <li>üì¶ Area Aktif: <b>Bandung</b></li>
          </ul>

          <h2 class="text-lg font-semibold mt-6 mb-3">‚öôÔ∏è Aksi Cepat</h2>
          <div class="space-y-2">
            <button
              id="addMarkerBtn"
              class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition"
            >
              ‚ûï Tambah Marker
            </button>
            <button
              id="drawAreaBtn"
              class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
            >
              üü© Buat Daerah
            </button>
            <button
              id="finishAreaBtn"
              class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition hidden"
            >
              ‚úÖ Selesai Gambar
            </button>
          </div>
        </div>

        <footer class="text-center text-gray-400 text-xs pt-4 border-t">
          Dibuat dengan ‚ù§Ô∏è oleh si Ganteng
        </footer>
      </aside>

      <!-- Peta -->
      <main class="flex-1 p-4">
        <div id="map" class="h-full shadow-lg"></div>
      </main>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // API base URL (backend)
      const API_BASE = "https://be-geojson-production.up.railway.app/api";

      // Inisialisasi peta
      var map = L.map("map").setView([-6.9175, 107.6191], 13);

      // Tambahkan tile layer
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      }).addTo(map);

      // === Variabel global ===
      var markerCount = 0;
      var areaCount = 0;
      var isDrawing = false;
      var currentPolygonPoints = [];

      // === Helper: update info ===
      function updateInfo(lat, lng, name = "") {
        document.getElementById("infoBox").innerHTML = `${
          name ? `<b>Nama Marker:</b> ${name}<br>` : ""
        }
         <b>Latitude:</b> ${lat.toFixed(5)} <br>
         <b>Longitude:</b> ${lng.toFixed(5)}`;
      }

      // === API helpers ===
      async function fetchMarkers() {
        try {
          const res = await fetch(`${API_BASE}/markers`);
          if (!res.ok) throw new Error("Failed to fetch markers");
          const markers = await res.json();
          markers.forEach((m) => {
            // assume coordinates are [lng, lat]
            const coords =
              m.location && m.location.coordinates
                ? m.location.coordinates
                : null;
            if (coords && coords.length === 2) {
              const dbid = m.id
                ? typeof m.id === "string"
                  ? m.id
                  : m.id.$oid || m.id
                : m._id
                ? typeof m._id === "string"
                  ? m._id
                  : m._id.$oid || m._id
                : null;
              addMarker(coords[1], coords[0], m.name, false, dbid);
            }
          });
          markerCount = markers.length;
          document.getElementById("markerCount").textContent = markerCount;
        } catch (err) {
          console.warn("fetchMarkers error", err);
        }
      }

      async function fetchAreas() {
        try {
          const res = await fetch(`${API_BASE}/areas`);
          if (!res.ok) throw new Error("Failed to fetch areas");
          const areas = await res.json();
          areas.forEach((a) => {
            // a.coordinates is a GeoJSONPolygon object with { type, coordinates: [ [ [lng,lat], ... ] ] }
            if (
              a.coordinates &&
              a.coordinates.coordinates &&
              a.coordinates.coordinates.length
            ) {
              const rings = a.coordinates.coordinates[0];
              const pts = rings.map((p) => [p[1], p[0]]); // convert to [lat,lng]
              const poly = L.polygon(pts, {
                color: "green",
                fillOpacity: 0.3,
              }).addTo(map);
              // attach db id and name
              poly._dbid = a.id
                ? typeof a.id === "string"
                  ? a.id
                  : a.id.$oid || a.id
                : a._id
                ? typeof a._id === "string"
                  ? a._id
                  : a._id.$oid || a._id
                : null;
              poly._name = a.name || "Area";
              const editId =
                "area_edit_" + Math.random().toString(36).slice(2, 9);
              const delId =
                "area_del_" + Math.random().toString(36).slice(2, 9);
              poly.bindPopup(
                `<b>${poly._name}</b><br><button id="${editId}" class="px-2 py-1 mt-2 bg-yellow-400 rounded">Edit</button> <button id="${delId}" class="px-2 py-1 mt-2 bg-red-500 text-white rounded">Hapus</button>`
              );
              poly.on("popupopen", function (e) {
                const editBtn = document.getElementById(editId);
                const delBtn = document.getElementById(delId);
                if (editBtn) {
                  editBtn.onclick = async function () {
                    const newName = prompt("Ubah nama area:", poly._name);
                    if (!newName) return;
                    // prepare coordinates in [ [ [lng,lat], ... ] ] format
                    const latlngs = poly
                      .getLatLngs()[0]
                      .map((p) => [p.lng, p.lat]);
                    // ensure closed
                    if (
                      latlngs.length &&
                      (latlngs[0][0] !== latlngs[latlngs.length - 1][0] ||
                        latlngs[0][1] !== latlngs[latlngs.length - 1][1])
                    )
                      latlngs.push([latlngs[0][0], latlngs[0][1]]);
                    const payload = {
                      name: newName,
                      coordinates: { type: "Polygon", coordinates: [latlngs] },
                    };
                    if (!poly._dbid) {
                      alert("Area belum disimpan ke server");
                      return;
                    }
                    const updated = await updateAreaRequest(
                      poly._dbid,
                      payload
                    );
                    if (updated) {
                      poly._name = newName;
                      poly.setPopupContent(
                        `<b>${poly._name}</b><br><button id="${editId}" class="px-2 py-1 mt-2 bg-yellow-400 rounded">Edit</button> <button id="${delId}" class="px-2 py-1 mt-2 bg-red-500 text-white rounded">Hapus</button>`
                      );
                    }
                  };
                }
                if (delBtn) {
                  delBtn.onclick = async function () {
                    if (!confirm("Hapus area ini?")) return;
                    if (!poly._dbid) {
                      poly.remove();
                      areaCount = Math.max(0, areaCount - 1);
                      document.getElementById("areaCount").textContent =
                        areaCount;
                      return;
                    }
                    const ok = await deleteAreaRequest(poly._dbid);
                    if (ok) {
                      poly.remove();
                      areaCount = Math.max(0, areaCount - 1);
                      document.getElementById("areaCount").textContent =
                        areaCount;
                    }
                  };
                }
              });
            }
          });
          areaCount = areas.length;
          document.getElementById("areaCount").textContent = areaCount;
        } catch (err) {
          console.warn("fetchAreas error", err);
        }
      }

      async function postMarker(name, lat, lng) {
        const payload = {
          name: name,
          location: { type: "Point", coordinates: [lng, lat] },
        };
        try {
          const res = await fetch(`${API_BASE}/markers`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to create marker");
          const created = await res.json();
          return created;
        } catch (err) {
          console.warn("postMarker error", err);
          return null;
        }
      }

      async function updateMarkerRequest(id, payload) {
        try {
          const res = await fetch(`${API_BASE}/markers/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to update marker");
          return await res.json();
        } catch (err) {
          console.warn("updateMarker error", err);
          return null;
        }
      }

      async function deleteMarkerRequest(id) {
        try {
          const res = await fetch(`${API_BASE}/markers/${id}`, {
            method: "DELETE",
          });
          if (!res.ok && res.status !== 204)
            throw new Error("Failed to delete marker");
          return true;
        } catch (err) {
          console.warn("deleteMarker error", err);
          return false;
        }
      }

      async function postArea(name, latlngs) {
        // latlngs: array of [lat, lng]
        const ring = latlngs.map((p) => [p[1], p[0]]); // to [lng, lat]
        // ensure ring is closed
        if (
          ring.length &&
          (ring[0][0] !== ring[ring.length - 1][0] ||
            ring[0][1] !== ring[ring.length - 1][1])
        ) {
          ring.push([ring[0][0], ring[0][1]]);
        }
        const payload = {
          name: name,
          coordinates: { type: "Polygon", coordinates: [ring] },
        };
        try {
          const res = await fetch(`${API_BASE}/areas`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to create area");
          const created = await res.json();
          return created;
        } catch (err) {
          console.warn("postArea error", err);
          return null;
        }
      }

      // Area update/delete helpers
      async function updateAreaRequest(id, payload) {
        try {
          const res = await fetch(`${API_BASE}/areas/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error("Failed to update area");
          return await res.json();
        } catch (err) {
          console.warn("updateArea error", err);
          return null;
        }
      }

      async function deleteAreaRequest(id) {
        try {
          const res = await fetch(`${API_BASE}/areas/${id}`, {
            method: "DELETE",
          });
          if (!res.ok && res.status !== 204)
            throw new Error("Failed to delete area");
          return true;
        } catch (err) {
          console.warn("deleteArea error", err);
          return false;
        }
      }

      // === Fungsi tambah marker (lokal + optional POST) ===
      function addMarker(
        lat,
        lng,
        name = "Marker Baru",
        doPost = true,
        dbid = null
      ) {
        const editId = "edit_" + Math.random().toString(36).slice(2, 9);
        const delId = "del_" + Math.random().toString(36).slice(2, 9);

        var popupHtml = `<b>${name}</b><br>${lat.toFixed(5)}, ${lng.toFixed(
          5
        )}<br><button id="${editId}" class="px-2 py-1 mt-2 bg-yellow-400 rounded">Edit</button> <button id="${delId}" class="px-2 py-1 mt-2 bg-red-500 text-white rounded">Hapus</button>`;

        var marker = L.marker([lat, lng], { draggable: true })
          .addTo(map)
          .bindPopup(popupHtml)
          .openPopup();

        // attach db id if provided
        if (dbid) marker._dbid = dbid;

        marker.on("dragend", function (e) {
          var pos = e.target.getLatLng();
          updateInfo(pos.lat, pos.lng, name);
          marker.bindPopup(
            `<b>${name}</b><br>${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`
          );

          // if marker exists in DB, update coordinates
          if (marker._dbid) {
            const payload = {
              name: name,
              location: { type: "Point", coordinates: [pos.lng, pos.lat] },
            };
            updateMarkerRequest(marker._dbid, payload).catch(() => {});
          }
        });

        marker.on("popupopen", function () {
          const editBtn = document.getElementById(editId);
          const delBtn = document.getElementById(delId);
          if (editBtn) {
            editBtn.onclick = async function () {
              const newName = prompt("Ubah nama marker:", name);
              if (!newName) return;
              const pos = marker.getLatLng();
              if (marker._dbid) {
                const payload = {
                  name: newName,
                  location: { type: "Point", coordinates: [pos.lng, pos.lat] },
                };
                const updated = await updateMarkerRequest(
                  marker._dbid,
                  payload
                );
                if (updated) {
                  name = newName;
                  marker.bindPopup(
                    `<b>${name}</b><br>${pos.lat.toFixed(5)}, ${pos.lng.toFixed(
                      5
                    )}`
                  );
                  updateInfo(pos.lat, pos.lng, name);
                }
              } else {
                // not yet persisted: just change locally
                name = newName;
                marker.bindPopup(
                  `<b>${name}</b><br>${pos.lat.toFixed(5)}, ${pos.lng.toFixed(
                    5
                  )}`
                );
              }
            };
          }
          if (delBtn) {
            delBtn.onclick = async function () {
              if (!confirm("Hapus marker ini?")) return;
              if (marker._dbid) {
                const ok = await deleteMarkerRequest(marker._dbid);
                if (ok) {
                  marker.remove();
                  markerCount = Math.max(0, markerCount - 1);
                  document.getElementById("markerCount").textContent =
                    markerCount;
                }
              } else {
                marker.remove();
                markerCount = Math.max(0, markerCount - 1);
                document.getElementById("markerCount").textContent =
                  markerCount;
              }
            };
          }
        });

        marker.on("click", function (e) {
          updateInfo(e.latlng.lat, e.latlng.lng, name);
        });

        if (doPost) {
          postMarker(name, lat, lng).then((created) => {
            if (created) {
              // attach db id if returned
              if (created.id) marker._dbid = created.id;
              markerCount++;
              document.getElementById("markerCount").textContent = markerCount;
            }
          });
        } else {
          markerCount++;
          document.getElementById("markerCount").textContent = markerCount;
        }
      }

      // === Init: load existing markers & areas from backend ===
      fetchMarkers();
      fetchAreas();

      // === Tombol tambah marker (mengirim ke backend) ===
      document
        .getElementById("addMarkerBtn")
        .addEventListener("click", function () {
          var lat = -6.9175 + (Math.random() - 0.5) * 0.02;
          var lng = 107.6191 + (Math.random() - 0.5) * 0.02;
          var name = prompt("Masukkan nama marker:", "Marker Baru");
          if (name) {
            addMarker(lat, lng, name, true);
          } else {
            addMarker(lat, lng, "Tanpa Nama", true);
          }
        });

      // === Mode menggambar area ===
      document
        .getElementById("drawAreaBtn")
        .addEventListener("click", function () {
          isDrawing = true;
          currentPolygonPoints = [];
          document.getElementById("drawAreaBtn").classList.add("hidden");
          document.getElementById("finishAreaBtn").classList.remove("hidden");
          document.getElementById("infoBox").innerHTML =
            "üü¢ Klik di peta untuk menandai titik area. Klik 'Selesai Gambar' untuk menutup polygon.";
        });

      // === Selesai menggambar area ===
      document
        .getElementById("finishAreaBtn")
        .addEventListener("click", async function () {
          if (currentPolygonPoints.length > 2) {
            const poly = L.polygon(currentPolygonPoints, {
              color: "green",
              fillOpacity: 0.3,
            }).addTo(map);
            // Ask for a name and POST to backend
            const name =
              prompt("Masukkan nama area:", "Area Baru") || "Area Baru";
            const created = await postArea(name, currentPolygonPoints);
            if (created) {
              // attach db id and name
              poly._dbid = created.id
                ? typeof created.id === "string"
                  ? created.id
                  : created.id.$oid || created.id
                : created._id
                ? typeof created._id === "string"
                  ? created._id
                  : created._id.$oid || created._id
                : null;
              poly._name = created.name || name;
              const editId =
                "area_edit_" + Math.random().toString(36).slice(2, 9);
              const delId =
                "area_del_" + Math.random().toString(36).slice(2, 9);
              poly.bindPopup(
                `<b>${poly._name}</b><br><button id="${editId}" class="px-2 py-1 mt-2 bg-yellow-400 rounded">Edit</button> <button id="${delId}" class="px-2 py-1 mt-2 bg-red-500 text-white rounded">Hapus</button>`
              );
              poly.on("popupopen", function (e) {
                const editBtn = document.getElementById(editId);
                const delBtn = document.getElementById(delId);
                if (editBtn) {
                  editBtn.onclick = async function () {
                    const newName = prompt("Ubah nama area:", poly._name);
                    if (!newName) return;
                    const latlngs = poly
                      .getLatLngs()[0]
                      .map((p) => [p.lng, p.lat]);
                    if (
                      latlngs.length &&
                      (latlngs[0][0] !== latlngs[latlngs.length - 1][0] ||
                        latlngs[0][1] !== latlngs[latlngs.length - 1][1])
                    )
                      latlngs.push([latlngs[0][0], latlngs[0][1]]);
                    const payload = {
                      name: newName,
                      coordinates: { type: "Polygon", coordinates: [latlngs] },
                    };
                    if (!poly._dbid) {
                      alert("Area belum disimpan ke server");
                      return;
                    }
                    const updated = await updateAreaRequest(
                      poly._dbid,
                      payload
                    );
                    if (updated) {
                      poly._name = newName;
                      poly.setPopupContent(
                        `<b>${poly._name}</b><br><button id="${editId}" class="px-2 py-1 mt-2 bg-yellow-400 rounded">Edit</button> <button id="${delId}" class="px-2 py-1 mt-2 bg-red-500 text-white rounded">Hapus</button>`
                      );
                    }
                  };
                }
                if (delBtn) {
                  delBtn.onclick = async function () {
                    if (!confirm("Hapus area ini?")) return;
                    if (!poly._dbid) {
                      poly.remove();
                      areaCount = Math.max(0, areaCount - 1);
                      document.getElementById("areaCount").textContent =
                        areaCount;
                      return;
                    }
                    const ok = await deleteAreaRequest(poly._dbid);
                    if (ok) {
                      poly.remove();
                      areaCount = Math.max(0, areaCount - 1);
                      document.getElementById("areaCount").textContent =
                        areaCount;
                    }
                  };
                }
              });
              areaCount++;
              document.getElementById("areaCount").textContent = areaCount;
              document.getElementById(
                "infoBox"
              ).innerHTML = `üü© Area selesai dibuat!<br>Jumlah titik: ${currentPolygonPoints.length}`;
            } else {
              // created failed ‚Äî keep polygon locally with name but no dbid
              poly._dbid = null;
              poly._name = name;
              const editId =
                "area_edit_" + Math.random().toString(36).slice(2, 9);
              const delId =
                "area_del_" + Math.random().toString(36).slice(2, 9);
              poly.bindPopup(
                `<b>${poly._name}</b><br><button id="${editId}" class="px-2 py-1 mt-2 bg-yellow-400 rounded">Edit</button> <button id="${delId}" class="px-2 py-1 mt-2 bg-red-500 text-white rounded">Hapus</button>`
              );
              poly.on("popupopen", function (e) {
                const editBtn = document.getElementById(editId);
                const delBtn = document.getElementById(delId);
                if (editBtn)
                  editBtn.onclick = function () {
                    const newName = prompt("Ubah nama area:", poly._name);
                    if (newName) {
                      poly._name = newName;
                      poly.setPopupContent(
                        `<b>${poly._name}</b><br><button id="${editId}" class="px-2 py-1 mt-2 bg-yellow-400 rounded">Edit</button> <button id="${delId}" class="px-2 py-1 mt-2 bg-red-500 text-white rounded">Hapus</button>`
                      );
                    }
                  };
                if (delBtn)
                  delBtn.onclick = function () {
                    if (confirm("Hapus area ini?")) {
                      poly.remove();
                      areaCount = Math.max(0, areaCount - 1);
                      document.getElementById("areaCount").textContent =
                        areaCount;
                    }
                  };
              });
            }
          } else {
            alert("Minimal 3 titik untuk membentuk area!");
          }
          isDrawing = false;
          document.getElementById("drawAreaBtn").classList.remove("hidden");
          document.getElementById("finishAreaBtn").classList.add("hidden");
          currentPolygonPoints = [];
        });

      // === Event klik di peta ===
      map.on("click", function (e) {
        if (isDrawing) {
          currentPolygonPoints.push([e.latlng.lat, e.latlng.lng]);
          L.circleMarker(e.latlng, { radius: 5, color: "green" }).addTo(map);
          updateInfo(e.latlng.lat, e.latlng.lng);
        } else {
          updateInfo(e.latlng.lat, e.latlng.lng);
        }
      });
    </script>
  </body>
</html>
